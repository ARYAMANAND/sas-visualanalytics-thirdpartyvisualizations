<!DOCTYPE html>
<!--
Copyright 2018 SAS Institute Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
	<!-- Import D3.js -->
	<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>

	<!-- Import utilities  -->
	<script type="text/javascript" src="../../util/messagingUtil.js"></script>
	<script type="text/javascript" src="../../util/contentUtil.js"></script>
</head>
<body>
<style type="text/css">
	html, body, svg {
		overflow: hidden;
		margin: 0px;
		width: 100%;
		height: 100%;
	}

	.data-bar {
		fill: steelblue;
	}

	.data-bar:hover {
		fill: lightsteelblue;
	}

	.data-bar.selected {
		stroke-width: 2px;
		stroke: black;
	}
</style>

<script>
	"use strict";

	document.addEventListener("DOMContentLoaded", function(e) {
		/*************************************************** Declare global variables ***************************************************/
		// Data variables
		var SVG_ID = "dynamic-bar";											// ID of SVG element
		var SAMPLE_MESSAGE = {
		    "version": "1",
		    "resultName": "dd75",
		    "rowCount": 6,
		    "availableRowCount": 6,
		    "data": [
		        [
		            "Hybrid",
		            3
		        ],
		        [
		            "Sedan",
		            262
		        ],
		        [
		            "Sports",
		            49
		        ],
		        [
		            "SUV",
		            60
		        ],
		        [
		            "Truck",
		            24
		        ],
		        [
		            "Wagon",
		            30
		        ]
		    ],
		    "columns": [
		        {
		            "name": "bi77",
		            "label": "Type",
		            "type": "string"
		        },
		        {
		            "name": "bi78",
		            "label": "Frequency",
		            "type": "number",
		            "usage": "quantitative",
		            "aggregation": "totalCount",
		            "format": {
		                "name": "COMMA",
		                "width": 12,
		                "precision": 0,
		                "formatString": "COMMA12."
		            }
		        }
		    ]
		};																	// Sample data message to render graph outside of VA for debugging
		var VA_MESSAGE;														// Data message to be received from VA
		var VA_RESULT_NAME;													// Result name required to send messages back to VA
		var SELECTED = [];													// Selected rows passed in from VA
		var DATA = [];														// Data to be parsed from VA data message

		// Static dimension variables
		var MARGIN = {top: 20, right: 20, bottom: 40, left: 40};			// Margin on interior edge of SVG
		var TRANS_TIME = 500;												// Duration of transitions

		// Dynamic dimension variables
		var WIDTH = window.innerWidth;										// Width of SVG element
		var HEIGHT = window.innerHeight;									// Height of SVG element
		var DRAWABLE_WIDTH = WIDTH - MARGIN.right - MARGIN.left;			// Drawable width of SVG
		var DRAWABLE_HEIGHT = HEIGHT - MARGIN.bottom - MARGIN.top;			// Drawable height of SVG

		// Selection and d3 variables
		var SVG;															// SVG selection
		var G_X_AXIS;														// X Axis Group selection
		var G_Y_AXIS;														// Y Axis Group selection
		var G_CHART_AREA;													// Chart Area Group selection
		var X_SCALE;														// X Scale
		var Y_SCALE;														// Y Scale
		var X_AXIS;															// X Axis data-join
		var Y_AXIS;															// Y Axis data-join
		var DATA_BARS;														// Data Bars data-join

		// Attach event for data message from VA
		va.messagingUtil.setOnDataReceivedCallback(onDataReceived);

		// If not being rendered in iFrame (outside VA), render with sample data
		if (!inIframe()) { onDataReceived(SAMPLE_MESSAGE); }

		// Listen for resize event
		va.contentUtil.setupResizeListener(drawElements);

		// Take action on received data
		function onDataReceived(messageFromVA) {
			// Initialize global data variables
			VA_MESSAGE = messageFromVA;
			VA_RESULT_NAME = messageFromVA.resultName;
			SELECTED = va.contentUtil.initializeSelections(messageFromVA);

			// Validate data roles
			if (!va.contentUtil.validateRoles(messageFromVA, ["string", "number"], null)) {
				va.messagingUtil.postInstructionalMessage(VA_RESULT_NAME,
					"D3 Bar Chart expects columns to be assigned in this order:\n" +
					" 1. Category (string)\n" +
					" 2. Measure (number)");
				return;
			}

			// Parse data from 2d array to array of objects
			DATA = [];
			for (var i=0, length=VA_MESSAGE.data.length; i<length; i++) {
				DATA.push({
					x: VA_MESSAGE.data[i][0],
					y: VA_MESSAGE.data[i][1]
				});
			}

			// Initialize chart if first draw, otherwise process data and update elements accordingly
			if (d3.select("#" + SVG_ID).empty()) {
				drawElements();
			}
			else {
				updateElements();
			}

			// Apply selections
			d3.selectAll(".selectable")
				.classed("selected", false)
				.filter(function(d, i) {
					return SELECTED.find(function(selection) {
						 return selection.row == i;
					 });
				})
				.classed("selected", true);
		}

		// Draw elements for first time and on resize event
		function drawElements() {
			// Calculate dimensions for graph based on container dimensions
			WIDTH = window.innerWidth;
			HEIGHT = window.innerHeight;
			DRAWABLE_WIDTH = WIDTH - MARGIN.right - MARGIN.left;
			DRAWABLE_HEIGHT = HEIGHT - MARGIN.bottom - MARGIN.top;

			// Append svg and save reference
			d3.select("body").selectAll("#" + SVG_ID).data([DATA]).enter().append("svg")
				.attr("id", SVG_ID)
				.on("click", deselectAllElements);

			SVG = d3.select("#" + SVG_ID)
				.attr("width", WIDTH)
				.attr("height", HEIGHT);

			// Append/update x-axis group and save reference
			SVG.selectAll(".g-x-axis").data([DATA]).enter().append("g")
				.classed("g-x-axis", true);

			G_X_AXIS = SVG.select(".g-x-axis")
				.attr("transform", "translate(" + (MARGIN.left) + "," + (HEIGHT-MARGIN.bottom) + ")");

			// Append/update y-axis group and save reference
			SVG.selectAll(".g-y-axis").data([DATA]).enter().append("g")
				.classed("g-y-axis", true)
				.attr("transform", "translate(" + (MARGIN.left) + "," + (MARGIN.top) + ")");

			G_Y_AXIS = SVG.select(".g-y-axis");

			// Append/update chart-area group and save reference
			SVG.selectAll(".g-chart-area").data([DATA]).enter().append("g")
				.classed("g-chart-area", true)
				.attr("transform", "translate(" + (MARGIN.left) + "," + (MARGIN.top) + ")");

			G_CHART_AREA = SVG.select(".g-chart-area");

			// Create x scale
			X_SCALE = d3.scaleBand().rangeRound([0, DRAWABLE_WIDTH]).padding(0.1)
				.domain(DATA.map(function(d) { return d.x; }));

			// Create y scale
			Y_SCALE = d3.scaleLinear().rangeRound([DRAWABLE_HEIGHT, 0])
				.domain([0, d3.max(DATA, function(d) { return d.y; })]);

			// Create x axis
			X_AXIS = G_X_AXIS.selectAll(".x-axis").data([DATA]);

			X_AXIS.enter().append("g")
				.classed("x-axis", true)
			.merge(X_AXIS)
				.call(d3.axisBottom(X_SCALE));

			// Create y axis
			Y_AXIS = G_Y_AXIS.selectAll(".y-axis").data([DATA]);

			Y_AXIS.enter().append("g")
				.classed("y-axis", true)
			.merge(Y_AXIS)
				.call(d3.axisLeft(Y_SCALE));

			// Create bars for each
			DATA_BARS = G_CHART_AREA.selectAll(".data-bar").data(DATA, function(d) { return d.x; });

			DATA_BARS.enter().append("rect")
				.classed("data-bar", true)
				.classed("selectable", true)
				.on("click", function(d, i) { selectElement(d, i, this); })
			.merge(DATA_BARS)
				.attr("x", function(d) { return X_SCALE(d.x); })
				.attr("y", function(d) { return Y_SCALE(d.y); })
				.attr("width", function(d) { return X_SCALE.bandwidth(); })
				.attr("height", function(d) { return DRAWABLE_HEIGHT - Y_SCALE(d.y); });
		}

		// Redraw data dependent elements on data change
		function updateElements() {
			// Update x scale
			X_SCALE = d3.scaleBand().rangeRound([0, DRAWABLE_WIDTH]).padding(0.1)
				.domain(DATA.map(function(d) { return d.x; }));

			// Update y scale
			Y_SCALE = d3.scaleLinear().rangeRound([DRAWABLE_HEIGHT, 0])
				.domain([0, d3.max(DATA, function(d) { return d.y; })]);

			// Update x axis
			X_AXIS = G_X_AXIS.selectAll(".x-axis").data([DATA])

			X_AXIS.transition().duration(TRANS_TIME)
				.call(d3.axisBottom(X_SCALE));

			// Update x axis
			Y_AXIS = G_Y_AXIS.selectAll(".y-axis").data([DATA])

			Y_AXIS.transition().duration(TRANS_TIME)
				.call(d3.axisLeft(Y_SCALE));

			// Enter/Update/Exit data bars
			DATA_BARS = G_CHART_AREA.selectAll(".data-bar").data(DATA, function(d) { return d.x; });

			DATA_BARS.transition().duration(TRANS_TIME)
				.attr("x", function(d) { return X_SCALE(d.x); })
				.attr("y", function(d) { return Y_SCALE(d.y); })
				.attr("width", function(d) { return X_SCALE.bandwidth(); })
				.attr("height", function(d) { return DRAWABLE_HEIGHT - Y_SCALE(d.y); });

			DATA_BARS.enter().append("rect")
				.classed("data-bar", true)
				.classed("selectable", true)
				.on("click", function(d, i) { selectElement(d, i, this); })
				.attr("x", function(d) { return X_SCALE(d.x); })
				.attr("y", function(d) { return Y_SCALE(d.y); })
				.attr("width", function(d) { return X_SCALE.bandwidth(); })
				.attr("height", function(d) { return DRAWABLE_HEIGHT - Y_SCALE(d.y); })
				.style("opacity", 0)
			.transition().duration(TRANS_TIME)
				.style("opacity", 1);

			DATA_BARS.exit().transition().duration(TRANS_TIME)
				.style("opacity", 0)
				.remove();
		}

		/******************************************************* Helper Functions *******************************************************/
		// Determine whether or not page is being rendered in iFrame
		function inIframe () {
			try {
				return window.self !== window.top;
			} catch (e) {
				return true;
			}
		}

		// Deselect all on svg click
		function deselectAllElements() {
			// Deselect all elements
			d3.selectAll(".selectable").classed("selected", false);

			// Post message to VA
			va.messagingUtil.postSelectionMessage(VA_RESULT_NAME, []);
		}

		// Handle selection on element
		function selectElement(datum, index, el) {
			// Prevent event from falling through to underlying elements
			d3.event.stopPropagation();

			// If control is held toggle selected on click preserving array, otherwise select only clicked element
			if (d3.event.ctrlKey) {
				// Toggle selection on clicked element
				d3.select(el).classed("selected", !d3.select(el).classed("selected"));

				// Build array of selected elements
				var selections = [];
				d3.selectAll(".selectable").each(function(d, i){
					if (d3.select(this).classed("selected")) {
						selections.push({row: i});
					}
				});

				// Post message to VA
				va.messagingUtil.postSelectionMessage(VA_RESULT_NAME, selections);
			}
			else {
				// Deselect all elements
				d3.selectAll(".selectable").classed("selected", false);

				// Select clicked element
				d3.select(el).classed("selected", true);

				// Post message to VA
				va.messagingUtil.postSelectionMessage(VA_RESULT_NAME, [{row: index}]);
			}
		}
	});
</script>
</body>
</html>
