<!DOCTYPE html>
<html>
<head>
	<!-- Import D3.js -->
	<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>

	<!-- Import jQuery -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<!-- Import utilities  -->
	<script type="text/javascript" src="https://sassoftware.github.io/sas-visualanalytics-thirdpartyvisualizations/util/messagingUtil.js"></script>
	<script type="text/javascript" src="https://sassoftware.github.io/sas-visualanalytics-thirdpartyvisualizations/util/contentUtil.js"></script>
</head>
<body>
<style type="text/css">
	html, body, svg {
		overflow: hidden;
		margin: 0px;
		width: 100%;
		height: 100%;
	}

	.data-bar {
		fill: steelblue;
	}

	.data-bar:hover {
		fill: lightsteelblue;
	}

	.data-bar.selected {
		stroke-width: 2px;
		stroke: black;
	}
</style>

<SVG id="dynamic-bar"></SVG>

<script>
	"use strict";

	$(function() {
		/*************************************************** Declare global variables ***************************************************/
		// Data variables
		var SVG_ID = "dynamic-bar";											// ID of SVG element
		var SAMPLE_MESSAGE = {
		    "version": "1",
		    "resultName": "dd75",
		    "rowCount": 6,
		    "availableRowCount": 6,
		    "data": [
		        [
		            "Hybrid",
		            3
		        ],
		        [
		            "Sedan",
		            262
		        ],
		        [
		            "Sports",
		            49
		        ],
		        [
		            "SUV",
		            60
		        ],
		        [
		            "Truck",
		            24
		        ],
		        [
		            "Wagon",
		            30
		        ]
		    ],
		    "columns": [
		        {
		            "name": "bi77",
		            "label": "Type",
		            "type": "string"
		        },
		        {
		            "name": "bi78",
		            "label": "Frequency",
		            "type": "number",
		            "usage": "quantitative",
		            "aggregation": "totalCount",
		            "format": {
		                "name": "COMMA",
		                "width": 12,
		                "precision": 0,
		                "formatString": "COMMA12."
		            }
		        }
		    ]
		};																	// Sample data message to render graph outside of VA for debugging
		var VA_MESSAGE;														// Data message to be received from VA
		var VA_RESULT_NAME;													// Result name required to send messages back to VA
		var DATA = [];														// Data to be parsed from VA data message

		// Static dimension variables
		var MARGIN = {top: 20, right: 20, bottom: 40, left: 40};			// Margin on interior edge of SVG
		var TRANS_TIME = 500;												// Duration of transitions

		// Dynamic dimension variables
		var WIDTH = window.innerWidth;										// Width of SVG element
		var HEIGHT = window.innerHeight;									// Height of SVG element
		var DRAWABLE_WIDTH = WIDTH - MARGIN.right - MARGIN.left;			// Drawable width of SVG
		var DRAWABLE_HEIGHT = HEIGHT - MARGIN.bottom - MARGIN.top;			// Drawable height of SVG

		// Selection and d3 variables
		var SVG;															// SVG selection
		var G_X_AXIS;														// X Axis Group selection
		var G_Y_AXIS;														// Y Axis Group selection
		var G_CHART_AREA;													// Chart Area Group selection
		var X_SCALE;														// X Scale
		var Y_SCALE;														// Y Scale
		var X_AXIS;															// X Axis data-join
		var Y_AXIS;															// Y Axis data-join
		var DATA_BARS;														// Data Bars data-join

		// Attach event for data message from VA
		va.messagingUtil.setOnDataReceivedCallback(onDataReceived);

		// If not being rendered in iFrame (outside VA), render with sample data
		if (!inIframe()) { onDataReceived(SAMPLE_MESSAGE); }

		// Listen for resize event
		va.contentUtil.setupResizeListener(drawElements);

		// Take action on received data
		function onDataReceived(messageFromVA) {
			// Initialize global data variables
			VA_MESSAGE = messageFromVA;
			VA_RESULT_NAME = messageFromVA.resultName;

			// Validate data roles
			if (!va.contentUtil.validateRoles(messageFromVA, ["string", "number"], null)) {
				va.messagingUtil.postInstructionalMessage(VA_RESULT_NAME,
					"D3 Bar Chart expects columns to be assigned in this order:\n" +
					" 1. Category (string)\n" +
					" 2. Measure (number)");
				return;
			}

			// Parse data from 2d array to array of objects
			DATA = [];
			for (var i=0, length=VA_MESSAGE.data.length; i<length; i++) {
				DATA.push({
					x: VA_MESSAGE.data[i][0],
					y: VA_MESSAGE.data[i][1],
					selected: VA_MESSAGE.data[i][2]
				});
			}

			// Initialize chart if first draw, otherwise process data and update elements accordingly
			if ($("#" + SVG_ID).children().length == 0) {
				drawElements();
			}
			else {
				updateElements();
			}
		}

		// Draw elements for first time and on resize event
		function drawElements() {
			// Calculate dimensions for graph based on container dimensions
			WIDTH = window.innerWidth;
			HEIGHT = window.innerHeight;
			DRAWABLE_WIDTH = WIDTH - MARGIN.right - MARGIN.left;
			DRAWABLE_HEIGHT = HEIGHT - MARGIN.bottom - MARGIN.top;

			// Save reference for svg
			SVG = d3.select("#" + SVG_ID)
				.attr("width", WIDTH)
				.attr("height", HEIGHT)
				.on("click", deselectAllElements);

			// Append/update x-axis group and save reference
			SVG.selectAll(".g-x-axis").data([DATA]).enter().append("g")
				.classed("g-x-axis", true);

			G_X_AXIS = SVG.select(".g-x-axis")
				.attr("transform", "translate(" + (MARGIN.left) + "," + (HEIGHT-MARGIN.bottom) + ")");

			// Append/update y-axis group and save reference
			SVG.selectAll(".g-y-axis").data([DATA]).enter().append("g")
				.classed("g-y-axis", true)
				.attr("transform", "translate(" + (MARGIN.left) + "," + (MARGIN.top) + ")");

			G_Y_AXIS = SVG.select(".g-y-axis");

			// Append/update chart-area group and save reference
			SVG.selectAll(".g-chart-area").data([DATA]).enter().append("g")
				.classed("g-chart-area", true)
				.attr("transform", "translate(" + (MARGIN.left) + "," + (MARGIN.top) + ")");

			G_CHART_AREA = SVG.select(".g-chart-area");

			// Create x scale
			X_SCALE = d3.scaleBand().rangeRound([0, DRAWABLE_WIDTH]).padding(0.1)
				.domain(DATA.map(function(d) { return d.x; }));

			// Create y scale
			Y_SCALE = d3.scaleLinear().rangeRound([DRAWABLE_HEIGHT, 0])
				.domain([0, d3.max(DATA, function(d) { return d.y; })]);

			// Create x axis
			X_AXIS = G_X_AXIS.selectAll(".x-axis").data([DATA]);

			X_AXIS.enter().append("g")
				.classed("x-axis", true)
			.merge(X_AXIS)
				.call(d3.axisBottom(X_SCALE));

			// Create y axis
			Y_AXIS = G_Y_AXIS.selectAll(".y-axis").data([DATA]);

			Y_AXIS.enter().append("g")
				.classed("y-axis", true)
			.merge(Y_AXIS)
				.call(d3.axisLeft(Y_SCALE));

			// Create bars for each
			DATA_BARS = G_CHART_AREA.selectAll(".data-bar").data(DATA, function(d) { return d.x; });

			DATA_BARS.enter().append("rect")
				.classed("data-bar", true)
				.classed("selectable", true)
				.classed("selected", function(d) { return d.selected; })
				.on("click", function(d, i) { selectElement(d, i, this); })
			.merge(DATA_BARS)
				.attr("x", function(d) { return X_SCALE(d.x); })
				.attr("y", function(d) { return Y_SCALE(d.y); })
				.attr("width", function(d) { return X_SCALE.bandwidth(); })
				.attr("height", function(d) { return DRAWABLE_HEIGHT - Y_SCALE(d.y); });
		}

		// Redraw data dependent elements on data change
		function updateElements() {
			// Update x scale
			X_SCALE = d3.scaleBand().rangeRound([0, DRAWABLE_WIDTH]).padding(0.1)
				.domain(DATA.map(function(d) { return d.x; }));

			// Update y scale
			Y_SCALE = d3.scaleLinear().rangeRound([DRAWABLE_HEIGHT, 0])
				.domain([0, d3.max(DATA, function(d) { return d.y; })]);

			// Update x axis
			X_AXIS = G_X_AXIS.selectAll(".x-axis").data([DATA])

			X_AXIS.transition().duration(TRANS_TIME)
				.call(d3.axisBottom(X_SCALE));

			// Update x axis
			Y_AXIS = G_Y_AXIS.selectAll(".y-axis").data([DATA])

			Y_AXIS.transition().duration(TRANS_TIME)
				.call(d3.axisLeft(Y_SCALE));

			// Enter/Update/Exit data bars
			DATA_BARS = G_CHART_AREA.selectAll(".data-bar").data(DATA, function(d) { return d.x; });

			DATA_BARS.transition().duration(TRANS_TIME)
				.attr("x", function(d) { return X_SCALE(d.x); })
				.attr("y", function(d) { return Y_SCALE(d.y); })
				.attr("width", function(d) { return X_SCALE.bandwidth(); })
				.attr("height", function(d) { return DRAWABLE_HEIGHT - Y_SCALE(d.y); });

			DATA_BARS.enter().append("rect")
				.classed("data-bar", true)
				.classed("selectable", true)
				.classed("selected", function(d) { return d.selected; })
				.on("click", function(d, i) { selectElement(d, i, this); })
				.attr("x", function(d) { return X_SCALE(d.x); })
				.attr("y", function(d) { return Y_SCALE(d.y); })
				.attr("width", function(d) { return X_SCALE.bandwidth(); })
				.attr("height", function(d) { return DRAWABLE_HEIGHT - Y_SCALE(d.y); })
				.style("opacity", .000001)
			.transition().duration(TRANS_TIME)
				.style("opacity", 1);

			DATA_BARS.exit().transition().duration(TRANS_TIME)
				.style("opacity", 0.000001)
				.remove();
		}

		// Deselect all on svg click
		function deselectAllElements() {
			d3.selectAll(".selectable").each(function(d) { d.selected = false; });
			d3.selectAll(".selectable").classed("selected", false);
			va.messagingUtil.postSelectionMessage(VA_RESULT_NAME, []);
		}

		// Handle selection on element
		function selectElement(d, i, el) {
			// Prevent event from falling through to underlying elements
			d3.event.stopPropagation();

			// Bring element to front in case there is overlap with other elements
			d3.select(el).moveToFront();

			// If control is held toggle selected on click preserving array, otherwise select only clicked element
			if (d3.event.ctrlKey) {
				d.selected = !d.selected;
				d3.select(el).classed("selected", d.selected);

				var selections = [];
				d3.selectAll(".selectable").each(function(d, i){
					if (d.selected) {
						selections.push({row: i});
					}
				});

				va.messagingUtil.postSelectionMessage(VA_RESULT_NAME, selections);
			}
			else {
				d3.selectAll(".selectable").each(function(d) { d.selected = false; });
				d3.selectAll(".selectable").classed("selected", false);
				d.selected = true;
				d3.select(el).classed("selected", true);
				va.messagingUtil.postSelectionMessage(VA_RESULT_NAME, [{row: i}]);
			}
		}

		/******************************************************* Helper Functions *******************************************************/
		// Determine whether or not page is being rendered in iFrame
		function inIframe () {
			try {
				return window.self !== window.top;
			} catch (e) {
				return true;
			}
		}
		// Bring element to front of SVG (from https://github.com/wbkd/d3-extended)
		d3.selection.prototype.moveToFront = function() {
	    	return this.each(function(){
	    		this.parentNode.appendChild(this);
	    	});
		};
	});
</script>
</body>
</html>
